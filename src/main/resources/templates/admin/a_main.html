<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 | LinkUp 관리</title>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/js/css/a_main.css" th:href="@{/js/css/a_main.css}" />

    <script>
        $(document).ready(function () {
            // AJAX 요청 함수
            function sendRequest(url, method, data, successCallback, errorCallback) {
                $.ajax({
                    url: url,
                    method: method,
                    data: data,
                    beforeSend: function (xhr) {
                        const csrfToken = $("meta[name='_csrf']").attr("content");
                        const csrfHeader = $("meta[name='_csrf_header']").attr("content");
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: successCallback,
                    error: errorCallback
                });
            }

            // 차단, 잠금 해제, 역할 변경 버튼 이벤트
            $(".block-button, .unblock-button, .unlock-button, .role-button").click(function () {
                const self = $(this);
                const userId = self.data("id");
                const action = self.data("action");
                const blockReason = self.hasClass("block-button") ? prompt("차단 사유를 입력하세요 (부적절한 언어 사용, 비하, 기타)") : null;

                if (self.hasClass("block-button") && !blockReason) {
                    return; // 차단 사유를 입력하지 않으면 취소
                }

                // 데이터 설정 (blockReason이 필요할 경우만 포함)
                const data = blockReason ? { blockReason: blockReason } : { action: action };

                // URL 설정
                const url = self.hasClass("block-button") ? `/admin/users/block/${userId}` :
                    self.hasClass("unblock-button") ? `/admin/users/unblock/${userId}` :
                        self.hasClass("unlock-button") ? `/admin/users/unlock/${userId}` :
                            `/admin/users/${userId}/role`;

                // AJAX 요청 보내기
                sendRequest(url, 'POST', data, function (response) {
                    if (response === "success") {
                        alert(self.hasClass("block-button") || self.hasClass("unlock-button") ? "상태 변경되었습니다." : "변경되었습니다.");
                        location.reload();
                    } else {
                        alert("실패");
                    }
                }, function () {
                    alert("요청 실패");
                });
            });
        });
    </script>


</head>

<body>
    <!-- 헤더 -->
    <div th:replace="header :: header(${user})"></div>

    <main class="admin-container">
        <header class="page-header">
            <h1 class="page-title">
                <i class="fas fa-users-cog"></i>
                관리자 페이지
            </h1>
            <p class="page-description">사용자 관리 및 신고 게시글 관리</p>
        </header>

        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-user"></i>
                사용자
            </h2>
            <button onclick="location.href='/admin/listForAdminP'" class="report-btn">
                <i class="fas fa-flag"></i>
                신고 게시글 보기
            </button>
        </div>

        <div class="user-table-container">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>사용자명</th>
                        <th>이메일</th>
                        <th>전화번호</th>
                        <th>닉네임</th>
                        <th>생년월일</th>
                        <th>가입일자</th>
                        <th>역할</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="user, iterStat : ${users}"
                        th:style="'animation-delay: ' + ${iterStat.index * 0.05} + 's'">
                        <td><a th:href="@{/users/{idx}(idx=${user.uIdx})}" th:text="${user.id}"></a></td>
                        <td th:text="${user.uUsername}">사용자명</td>
                        <td th:text="${user.uEmail}">이메일</td>
                        <td th:text="${user.uTelephone}">전화번호</td>
                        <td th:text="${user.uNickname}">닉네임</td>
                        <td th:text="${user.uBirthday}">생년월일</td>
                        <td th:text="${#temporals.format(user.uCreatedAt, 'yyyy-MM-dd')}">가입일자</td>
                        <td th:text="${user.uRole}">역할</td>
                        <td>
                            <span th:if="${user.uBlock != null}" class="status-badge status-blocked">
                                <i class="fas fa-ban"></i> 차단됨
                            </span>
                            <span th:if="${user.uBlock == null && user.isAccountLocked}"
                                class="status-badge status-locked">
                                <i class="fas fa-lock"></i> 잠금됨
                            </span>
                            <span th:if="${user.uBlock == null && !user.isAccountLocked}"
                                class="status-badge status-normal">
                                <i class="fas fa-check-circle"></i> 정상
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button th:if="${user.uBlock == null}" class="action-btn btn-block block-button"
                                    th:data-id="${user.id}">
                                    <i class="fas fa-ban"></i> 차단
                                </button>
                                <button th:if="${user.uBlock != null}" class="action-btn btn-unblock unblock-button"
                                    th:data-id="${user.id}">
                                    <i class="fas fa-unlock"></i> 차단 해제
                                </button>
                                <button th:if="${user.isAccountLocked == true}"
                                    class="action-btn btn-unlock unlock-button" th:data-id="${user.id}">
                                    <i class="fas fa-unlock-alt"></i> 잠금 해제
                                </button>
                                <button
                                    th:if="${user.uRole == 'USER' || user.uRole == 'ADMIN' || user.uRole == 'SUB_ADMIN'}"
                                    th:class="${'action-btn ' + (user.uRole == 'USER' ? 'btn-promote' : 'btn-demote')} + ' role-button'"
                                    th:data-id="${user.id}"
                                    th:data-action="${user.uRole == 'USER' ? 'promote' : 'demote'}">
                                    <i
                                        th:class="${'fas ' + (user.uRole == 'USER' ? 'fa-arrow-up' : 'fa-arrow-down')}"></i>
                                    <span th:text="${user.uRole == 'USER' ? '관리자 승격' : '관리자 해제'}"></span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div th:if="${users.isEmpty()}" class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <h3>등록된 사용자가 없습니다</h3>
                <p>사용자가 등록되면 여기에 표시됩니다.</p>
            </div>
        </div>
    </main>
</body>

</html>