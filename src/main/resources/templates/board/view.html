<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시글 상세 보기</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/Js/b_view.js"></script>
    <script src="/js/Js/session-timer2.js"></script>
    <script src="/js/Js/ssenotification.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" th:href="@{/js/css/B_view.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <!-- CSRF 토큰을 메타 태그에 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
    <!-- 헤더 포함 -->
    <div th:replace="header :: header(${user})"></div>

    <div id="userId" th:data-username="${user != null ? (isSocial ? user.name : user.uNickname) : 'Anonymous'}"></div>
    <div id="userEmail" th:data-email="${user != null ? (isSocial ? user.uEmail : user.uEmail) : 'null'}"></div>

    <main class="board-container">
        <article class="board-post">
            <header class="post-header">
                <h1 class="post-title" th:text="${board.title}"></h1>
                <div class="post-meta">
                    <div class="author-info">
                        <i class="fas fa-user"></i>
                        <span class="author" th:text="${board.bWriter}">작성자</span>
                    </div>
                    <div class="post-stats">
                        <span class="view-count">
                            <i class="fas fa-eye"></i>
                            <span th:text="${board.viewCount}">조회 수</span>
                        </span>
                        <span class="upload-date">
                            <i class="fas fa-calendar"></i>
                            <span th:text="${#dates.format(board.uploadTime, 'yyyy-MM-dd HH:mm')}">작성일</span>
                        </span>
                    </div>
                </div>
                <div class="post-tools" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button type="button" id="shareBtn" class="submit-btn" style="border:none;">
                        <i class="fas fa-link"></i>
                        링크 복사
                    </button>
                </div>
            </header>

            <div class="post-content">
                <div class="content-text" th:text="${board.content}">내용</div>
                <div class="post-image" th:if="${board.filePath != null and !#strings.isEmpty(board.filePath)}">
                    <img th:src="@{'/file/' + ${board.getBWriter()} + '/' + ${board.getTitle()} + '/' + ${#strings.replace(board.getFilePath(), '\\', '/')}}"
                        alt="게시글 이미지" class="content-image" />
                </div>
            </div>

            <div class="post-actions">
                <div class="like-section">
                    <button type="button" id="likeButton" class="action-btn like-btn" th:data-board-id="${board.bIdx}">
                        <i class="fas fa-thumbs-up"></i>
                        <span>좋아요</span>
                        <span class="count" id="likeCount" th:text="${board.likeCount}">0</span>
                    </button>
                    <button type="button" id="dislikeButton" class="action-btn dislike-btn"
                        th:data-board-id="${board.bIdx}">
                        <i class="fas fa-thumbs-down"></i>
                        <span>싫어요</span>
                        <span class="count" id="dislikeCount" th:text="${board.dislikeCount}">0</span>
                    </button>
                </div>
            </div>
        </article>

        <section class="comment-section">
            <h3 class="section-title">
                <i class="fas fa-comments"></i>
                댓글
            </h3>

            <div class="comment-form">
                <div class="form-group">
                    <textarea id="commentContent" placeholder="댓글을 입력해주세요..." rows="3"></textarea>
                    <input type="hidden" id="writerId"
                        th:value="${user != null ? (isSocial ? user.name : user.uNickname) : 'Anonymous'}" />
                    <input type="hidden" id="writerEmail"
                        th:value="${user != null ? (isSocial ? user.uEmail : user.uEmail) : 'null'}" />
                    <input type="hidden" id="boardId" th:value="${board.bIdx}" />
                </div>
                <button type="button" id="commentSubmit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i>
                    댓글 달기
                </button>
            </div>
            <div class="comment-list" id="commentList">
                <div th:each="comment : ${comments}" class="comment-item">
                    <div class="comment-header">
                        <div class="comment-author">
                            <i class="fas fa-user-circle"></i>
                            <span class="author-name" th:text="${comment.c_writer}">작성자</span>
                            <span class="comment-number" th:text="'#' + ${comment.c_idx}">#번호</span>
                        </div>
                        <div class="comment-date">
                            <i class="fas fa-clock"></i>
                            <span th:text="${comment.c_upLoad}">작성일</span>
                        </div>
                    </div>

                    <div class="comment-body">
                        <div th:if="${comment.c_deleted == false}" class="comment-content"
                            th:text="${comment.c_content}">댓글 내용</div>
                        <div th:if="${comment.c_deleted == true}" class="deleted-comment">
                            <i class="fas fa-trash"></i>
                            삭제된 댓글입니다.
                        </div>
                    </div>

                    <div class="comment-actions" th:if="${comment.c_deleted == false}">
                        <div class="comment-reactions">
                            <button type="button" class="comment-like-button" th:data-comment-id="${comment.c_idx}">
                                <i class="fas fa-thumbs-up"></i>
                                <span class="comment-like-count" th:id="'comment-like-' + ${comment.c_idx}"
                                    th:text="${comment.c_like}">0</span>
                            </button>
                            <button type="button" class="comment-dislike-button" th:data-comment-id="${comment.c_idx}">
                                <i class="fas fa-thumbs-down"></i>
                                <span class="comment-dislike-count" th:id="'comment-dislike-' + ${comment.c_idx}"
                                    th:text="${comment.c_dislike}">0</span>
                            </button>
                        </div>

                        <div class="comment-controls">
                            <div
                                th:if="${(isSocial != null and (isSocial ? comment.c_writer == user.name : comment.c_writer == user.uNickname))}">
                                <button type="button" class="delete-comment-btn" th:data-comment-id="${comment.c_idx}">
                                    <i class="fas fa-trash"></i>
                                    삭제
                                </button>
                            </div>
                            <div th:if="${isSocial != null}">
                                <button type="button" id="reportComment" class="report-btn"
                                    th:data-comment-id="${comment.c_idx}">
                                    <i class="fas fa-flag"></i>
                                    신고
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pagination-container" th:if="${comments.totalPages >= 1}">
                <nav class="pagination-nav">
                    <ul class="pagination">
                        <li th:classappend="${comments.hasPrevious() ? '' : 'disabled'}">
                            <a th:href="@{'/board/' + ${board.bIdx} + '?page=' + ${comments.pageable.pageNumber - 1}}"
                                class="page-link">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(0, comments.totalPages - 1)}"
                            th:classappend="${comments.pageable.pageNumber == i ? 'active' : ''}">
                            <a th:href="@{'/board/' + ${board.bIdx} + '?page=' + ${i}}" class="page-link">[[${i +
                                1}]]</a>
                        </li>
                        <li th:classappend="${comments.hasNext() ? '' : 'disabled'}">
                            <a th:href="@{'/board/' + ${board.bIdx} + '?page=' + ${comments.pageable.pageNumber + 1}}"
                                class="page-link">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </section>
    </main>

    <footer class="board-footer">
        <a href="/board" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            목록으로 돌아가기
        </a>
    </footer>
    <script>
        (function () {
            var shareBtn = document.getElementById('shareBtn');
            if (!shareBtn) return;
            shareBtn.addEventListener('click', function () {
                var url = window.location.href;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url).then(function () {
                        if (window.Toastify) {
                            Toastify({ text: '링크가 복사되었습니다.', duration: 2000, gravity: 'top', position: 'center', backgroundColor: '#4f8cff' }).showToast();
                        } else {
                            alert('링크가 복사되었습니다.');
                        }
                    });
                } else {
                    var temp = document.createElement('input');
                    temp.value = url;
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                    if (window.Toastify) {
                        Toastify({ text: '링크가 복사되었습니다.', duration: 2000, gravity: 'top', position: 'center', backgroundColor: '#4f8cff' }).showToast();
                    } else {
                        alert('링크가 복사되었습니다.');
                    }
                }
            });
        })();
    </script>
</body>

</html>